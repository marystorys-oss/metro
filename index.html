<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>METRO R&S AI í˜„ì¥ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --success: #27ae60; --pdf: #e74c3c; --highlight: #f1c40f; }
        body { font-family: 'Malgun Gothic', sans-serif; margin: 0; background: #f0f2f5; font-size: 14px; color: #333; padding-bottom: 50px; }
        header { background: var(--primary); color: white; padding: 15px; text-align: center; font-weight: bold; position: sticky; top:0; z-index:100; }
        
        .container { padding: 10px; max-width: 800px; margin: auto; }
        .section { background: white; padding: 15px; border-radius: 8px; margin-bottom: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .section-title { font-weight: bold; color: var(--accent); margin-bottom: 12px; border-left: 4px solid var(--accent); padding-left: 8px; }
        
        .grid-input { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        
        /* ğŸŒŸ ë²ˆí˜¸ ì…ë ¥ì°½ ê°•ì¡° ìŠ¤íƒ€ì¼ */
        #no { grid-column: span 2; border: 2px solid var(--accent); background-color: #fdfbfb; font-weight: bold; font-size: 16px; color: var(--primary); }
        
        #site, #desc { grid-column: span 2; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; transition: 0.3s; }
        /* ìë™ì™„ì„± ë˜ì—ˆì„ ë•Œ ìƒ‰ìƒ ë³€í™” íš¨ê³¼ */
        .filled { background-color: #e8f6f3; border-color: var(--success); } 
        textarea { height: 60px; resize: none; }
        
        .photo-area { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 10px; }
        .photo-box { background: #f9f9f9; height: 90px; display: flex; align-items: center; justify-content: center; border: 2px dashed #ccc; border-radius: 6px; cursor: pointer; position: relative; overflow: hidden; }
        .preview-img { width: 100%; height: 100%; object-fit: cover; display: none; position: absolute; top:0; left:0; }
        
        .btn-group { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 15px; }
        button { flex: 1; min-width: 100px; padding: 12px; border: none; border-radius: 6px; color: white; font-weight: bold; cursor: pointer; }
        .btn-save { background: var(--success); }
        .btn-pdf { background: var(--pdf); }
        .btn-send { background: #e67e22; }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; background: white; font-size: 12px; min-width: 500px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        th { background: #f8f9fa; }

        #pdf-template { display: none; }
    </style>
</head>
<body>

<header>(ì£¼)METRO R&S í˜„ì¥ê´€ë¦¬ ì‹œìŠ¤í…œ v1.0</header>

<div class="container">
    <div class="section">
        <div class="section-title">âš™ï¸ ì—‘ì…€ DB ë¶ˆëŸ¬ì˜¤ê¸° (ìë™ì™„ì„±ìš©)</div>
        <input type="text" id="api-url" placeholder="https://sheetdb.io/api/v1/espz77lzn6sii" style="margin-bottom:10px;">
        <input type="file" id="excel-file" accept=".xlsx, .xls" onchange="loadExcelDB(this)">
        <p style="font-size: 11px; color: #888; margin-top: 5px;">* ì–‘ì‹: ë²ˆí˜¸, í˜„ì¥ëª…, ë™, í˜¸, ìœ„ì¹˜, ê³µì¢…, ìœ í˜•, ì‹œê³µì—…ì²´, ë‚´ìš© (A~Iì—´)</p>
    </div>

    <div class="section">
        <div class="section-title">âœï¸ í˜„ì¥ ì‘ì—… ê¸°ë¡</div>
        <div class="grid-input">
            <input type="number" id="no" placeholder="ğŸ” ê´€ë¦¬ ë²ˆí˜¸ ì…ë ¥ (ìë™ ì™„ì„±)" oninput="searchAndFill(this.value)">
            
            <input type="text" id="site" placeholder="í˜„ì¥ëª…">
            <input type="text" id="dong" placeholder="ë™">
            <input type="text" id="ho" placeholder="í˜¸">
            <input type="text" id="loc" placeholder="ìœ„ì¹˜">
            <input type="text" id="work" placeholder="ê³µì¢…">
            <input type="text" id="type" placeholder="í•˜ì ìœ í˜•">
            <input type="text" id="contractor" placeholder="ì‹œê³µì—…ì²´">
            <textarea id="desc" placeholder="í•˜ì ë‚´ìš© ì„¤ëª…"></textarea>
        </div>
        
        <div class="photo-area">
            <div class="photo-box" onclick="document.getElementById('f1').click()">
                <span id="t1">ìˆ˜ë¦¬ ì „ğŸ“·</span><img id="p1" class="preview-img">
                <input type="file" id="f1" hidden accept="image/*" capture="camera" onchange="view(this,'p1','t1')">
            </div>
            <div class="photo-box" onclick="document.getElementById('f2').click()">
                <span id="t2">ìˆ˜ë¦¬ í›„ğŸ“·</span><img id="p2" class="preview-img">
                <input type="file" id="f2" hidden accept="image/*" capture="camera" onchange="view(this,'p2','t2')">
            </div>
            <div class="photo-box" onclick="document.getElementById('f3').click()">
                <span id="t3">í™•ì¸ì„œğŸ“‹</span><img id="p3" class="preview-img">
                <input type="file" id="f3" hidden accept="image/*" capture="camera" onchange="view(this,'p3','t3')">
            </div>
        </div>

        <div class="btn-group">
            <button class="btn-save" onclick="saveLocal()">ì €ì¥ ì™„ë£Œ</button>
            <button class="btn-pdf" onclick="makePDF()">PDF ì €ì¥</button>
            <button class="btn-send" onclick="sendSheetDB()">ì‹œíŠ¸ ì „ì†¡</button>
        </div>
    </div>

    <div class="section">
        <div class="section-title">ğŸ“‹ ì‘ì—… ì™„ë£Œ ëª©ë¡ (<span id="count">0</span>ê±´)</div>
        <div style="overflow-x:auto;">
            <table id="list-table">
                <thead><tr><th>No</th><th>í˜„ì¥/ë™/í˜¸</th><th>ê³µì¢…/ìœ í˜•</th><th>ìƒíƒœ</th></tr></thead>
                <tbody id="list-body"></tbody>
            </table>
        </div>
    </div>
</div>

<div id="pdf-template" style="padding: 30px; background: white; width: 700px;">
    <h2 style="text-align:center;">í•˜ìë³´ìˆ˜ ì™„ë£Œ ë³´ê³ ì„œ</h2>
    <table style="width:100%; margin-top:20px; border-collapse: collapse;">
        <tr>
            <td style="background:#eee; width:15%; border:1px solid #ddd; padding:10px; font-weight:bold; text-align:center;">í˜„ì¥ëª…</td>
            <td id="pdf-site" colspan="3" style="border:1px solid #ddd; padding:10px;"></td>
        </tr>
        <tr>
            <td style="background:#eee; width:15%; border:1px solid #ddd; padding:10px; font-weight:bold; text-align:center;">ë™/í˜¸ìˆ˜</td>
            <td id="pdf-dongho" style="width:35%; border:1px solid #ddd; padding:10px;"></td>
            <td style="background:#eee; width:15%; border:1px solid #ddd; padding:10px; font-weight:bold; text-align:center;">ìœ„ì¹˜/ê³µì¢…</td>
            <td id="pdf-locwork" style="width:35%; border:1px solid #ddd; padding:10px;"></td>
        </tr>
        <tr>
            <td style="background:#eee; border:1px solid #ddd; padding:10px; font-weight:bold; text-align:center;">ìœ í˜•</td>
            <td id="pdf-type" style="border:1px solid #ddd; padding:10px;"></td>
            <td style="background:#eee; border:1px solid #ddd; padding:10px; font-weight:bold; text-align:center;">ì‹œê³µì—…ì²´</td>
            <td id="pdf-contractor" style="border:1px solid #ddd; padding:10px;"></td>
        </tr>
        <tr>
            <td style="background:#eee; border:1px solid #ddd; padding:10px; font-weight:bold; text-align:center;">ë‚´ìš©</td>
            <td id="pdf-desc" colspan="3" style="border:1px solid #ddd; padding:10px;"></td>
        </tr>
    </table>
    <div style="display:flex; gap:10px; margin-top:30px;">
        <div style="flex:1; text-align:center;"><p>[ìˆ˜ë¦¬ ì „]</p><img id="pdf-img1" style="width:100%; height:250px; object-fit:contain; border:1px solid #eee;"></div>
        <div style="flex:1; text-align:center;"><p>[ìˆ˜ë¦¬ í›„]</p><img id="pdf-img2" style="width:100%; height:250px; object-fit:contain; border:1px solid #eee;"></div>
    </div>
</div>

<script>
    let excelDB = []; // ì—‘ì…€ì—ì„œ ë¶ˆëŸ¬ì˜¨ ì›ë³¸ ë°ì´í„°ë¥¼ ë³´ê´€í•˜ëŠ” ì°½ê³ 
    let savedList = []; // ì‘ì—… ì™„ë£Œ í›„ ì „ì†¡ ëŒ€ê¸° ì¤‘ì¸ ë¦¬ìŠ¤íŠ¸

    // [1] ì—‘ì…€(.xlsx) íŒŒì¼ ë¶ˆëŸ¬ì™€ì„œ DBì— ì €ì¥
    function loadExcelDB(input) {
        const file = input.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const worksheet = workbook.Sheets[workbook.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

            excelDB = [];
            for (let i = 1; i < jsonData.length; i++) {
                const row = jsonData[i];
                if (row && row[0]) { // Aì—´(ë²ˆí˜¸)ì´ ìˆëŠ” ë°ì´í„°ë§Œ ì €ì¥
                    excelDB.push({
                        no: row[0].toString(),    // A: ë²ˆí˜¸ (ë¬¸ìë¡œ ë³€í™˜í•˜ì—¬ ë¹„êµí•˜ê¸° ì‰½ê²Œ í•¨)
                        site: row[1] || '',       // B: í˜„ì¥ëª…
                        dong: row[2] || '',       // C: ë™
                        ho: row[3] || '',         // D: í˜¸
                        loc: row[4] || '',        // E: ìœ„ì¹˜
                        work: row[5] || '',       // F: ê³µì¢…
                        type: row[6] || '',       // G: ìœ í˜•
                        contractor: row[7] || '', // H: ì‹œê³µì—…ì²´
                        desc: row[8] || ''        // I: ë‚´ìš©
                    });
                }
            }
            alert(`ì—‘ì…€ DB ë¡œë“œ ì™„ë£Œ! ì´ ${excelDB.length}ê±´ì˜ ë°ì´í„°ë¥¼ ìë™ì™„ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
        };
        reader.readAsArrayBuffer(file);
    }

    // [2] ğŸŒŸ ë²ˆí˜¸ ê²€ìƒ‰ ë° ìë™ ì±„ìš°ê¸° ê¸°ëŠ¥
    function searchAndFill(searchNo) {
        const fields = ['site', 'dong', 'ho', 'loc', 'work', 'type', 'contractor', 'desc'];
        
        // ì…ë ¥ì°½ì´ ë¹„ì—ˆìœ¼ë©´ ìƒ‰ìƒ ì›ìƒë³µêµ¬
        if(!searchNo) {
            fields.forEach(id => document.getElementById(id).classList.remove('filled'));
            return;
        }

        // ì—‘ì…€ DBì—ì„œ ì…ë ¥í•œ ë²ˆí˜¸ì™€ ì¼ì¹˜í•˜ëŠ” ë°ì´í„° ì°¾ê¸°
        const foundData = excelDB.find(item => item.no === searchNo.toString());

        if(foundData) {
            // ë°ì´í„°ê°€ ìˆìœ¼ë©´ í¼ì— ê°’ ì…ë ¥ ë° ì‹œê°ì  í”¼ë“œë°±(ìƒ‰ìƒ ë³€ê²½)
            fields.forEach(id => {
                document.getElementById(id).value = foundData[id];
                document.getElementById(id).classList.add('filled');
            });
        } else {
            // ì—†ëŠ” ë²ˆí˜¸ë©´ ì‹œê°ì  í”¼ë“œë°± ì œê±° (ê°’ì€ ìˆ˜ê¸° ì…ë ¥ì„ ìœ„í•´ ë†”ë‘ )
            fields.forEach(id => document.getElementById(id).classList.remove('filled'));
        }
    }

    // [3] ì‚¬ì§„ ë¯¸ë¦¬ë³´ê¸°
    function view(input, pId, tId) {
        if(input.files && input.files[0]){
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById(pId).src = e.target.result;
                document.getElementById(pId).style.display = 'block';
                document.getElementById(tId).style.display = 'none';
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    // [4] ì‘ì—… ì™„ë£Œ ì €ì¥ (ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€)
    function saveLocal() {
        const data = {
            no: document.getElementById('no').value,
            site: document.getElementById('site').value,
            dong: document.getElementById('dong').value,
            ho: document.getElementById('ho').value,
            loc: document.getElementById('loc').value,
            work: document.getElementById('work').value,
            type: document.getElementById('type').value,
            contractor: document.getElementById('contractor').value,
            desc: document.getElementById('desc').value
        };
        if(!data.dong || !data.ho) return alert("ë™ê³¼ í˜¸ìˆ˜ëŠ” í•„ìˆ˜ ì…ë ¥ì…ë‹ˆë‹¤.");
        
        savedList.push(data);
        updateTable();
        alert("ëª©ë¡ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.");
        
        // í¼ ì´ˆê¸°í™” (ë‹¤ìŒ ì‘ì—…ì„ ìœ„í•´)
        ['no','site','dong','ho','loc','work','type','contractor','desc'].forEach(id => {
            document.getElementById(id).value = '';
            document.getElementById(id).classList.remove('filled');
        });
        [1,2,3].forEach(i => {
            document.getElementById('p'+i).style.display = 'none';
            document.getElementById('t'+i).style.display = 'block';
            document.getElementById('f'+i).value = ''; // ì²¨ë¶€íŒŒì¼ ë¦¬ì…‹
        });
    }

    // í•˜ë‹¨ í…Œì´ë¸” ì—…ë°ì´íŠ¸
    function updateTable() {
        const body = document.getElementById('list-body');
        body.innerHTML = savedList.map(r => `<tr>
            <td>${r.no || '-'}</td>
            <td>${r.site}<br>${r.dong}-${r.ho}</td>
            <td>${r.work}<br><span style="color:#888; font-size:11px;">${r.type}</span></td>
            <td>âœ…</td>
        </tr>`).join('');
        document.getElementById('count').innerText = savedList.length;
    }

    // [5] PDF ìƒì„± (ê¸°ì¡´ê³¼ ë™ì¼)
    function makePDF() {
        document.getElementById('pdf-site').innerText = document.getElementById('site').value;
        document.getElementById('pdf-dongho').innerText = `${document.getElementById('dong').value}ë™ ${document.getElementById('ho').value}í˜¸`;
        document.getElementById('pdf-locwork').innerText = `${document.getElementById('loc').value} / ${document.getElementById('work').value}`;
        document.getElementById('pdf-type').innerText = document.getElementById('type').value;
        document.getElementById('pdf-contractor').innerText = document.getElementById('contractor').value;
        document.getElementById('pdf-desc').innerText = document.getElementById('desc').value;
        
        document.getElementById('pdf-img1').src = document.getElementById('p1').src;
        document.getElementById('pdf-img2').src = document.getElementById('p2').src;

        const target = document.getElementById('pdf-template');
        target.style.display = 'block';
        
        const opt = { 
            margin: 10, 
            filename: `í•˜ìë³´ê³ ì„œ_${document.getElementById('dong').value}ë™${document.getElementById('ho').value}í˜¸.pdf`, 
            image: { type: 'jpeg', quality: 0.98 }, 
            html2canvas: { scale: 2 }, 
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } 
        };
        
        html2pdf().set(opt).from(target).save().then(() => target.style.display = 'none');
    }

    // [6] SheetDB êµ¬ê¸€ ì‹œíŠ¸ ì „ì†¡
    async function sendSheetDB() {
        const url = document.getElementById('api-url').value;
        if(!url) return alert("SheetDB API URLì„ ë¨¼ì € ì…ë ¥í•˜ì„¸ìš”.");
        if(savedList.length === 0) return alert("ì „ì†¡í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
        
        try {
            await fetch(url, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ data: savedList }) // ğŸŒŸ ë²ˆí˜¸(no)ê°€ í¬í•¨ëœ 9ê°œ í•­ëª© ì „ì†¡
            });
            alert("êµ¬ê¸€ ì‹œíŠ¸ë¡œ ì•ˆì „í•˜ê²Œ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤!");
        } catch(e) { 
            console.error(e);
            alert("ì „ì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."); 
        }
    }
</script>
</body>
</html>